const User = require("../models/User");
const Role = require("../models/Role"); // Role modelini daxil edirik
const bcrypt = require("bcryptjs"); // Parolun ≈üifr…ôl…ônm…ôsi √º√ß√ºn
const ServicePackage = require("../models/ServicePackage");
const { createLog } = require("../services/logService");
const { getChangedFields } = require("../utils/utils");
exports.createUser = async (req, res) => {
  const {
    fname,
    lname,
    fathername,
    email,
    password,
    phoneNumber,
    status,
    role,
    bDate,
    identityNumber,
    dynamicFields,
    address,
  } = req.body;

  try {
    const requestingUser = req.user;

    const requesterRoleData = await Role.findById(requestingUser.roleId);
    if (!requesterRoleData) {
      return res.status(403).json({ message: "Sizin rol tapƒ±lmadƒ±" });
    }

    const isAdmin = requesterRoleData.name === "admin";

    if (!isAdmin) {
      const permissions = requesterRoleData.permissions; // üéØ Permissions artƒ±q requesterRoleData-dan g…ôlir!

      const rolePermission = permissions.roles?.find((rp) => rp.role === role);
      if (!rolePermission || !rolePermission.permissions.create) {
        return res
          .status(403)
          .json({ message: "ƒ∞stifad…ô√ßi yaratmaƒüa icaz…ôniz yoxdur" });
      }
    }

    const roleData = await Role.findById(role);
    if (!roleData) {
      return res.status(400).json({ message: "Role not found" });
    }

    let errors = {};

    if (email) {
      const existingUserByEmail = await User.findOne({ email });
      if (existingUserByEmail) {
        errors.email = "Bu e-po√ßt artƒ±q istifad…ô olunur";
      }
    }

    if (Object.keys(errors).length > 0) {
      return res.status(400).json({ errors });
    }

    const newUser = new User({
      fname,
      lname,
      fathername,
      email,
      password,
      phoneNumber,
      dynamicFields,
      identityNumber,
      status,
      role,
      address,
      bDate,
    });

    await newUser.save();
    await createLog({
      userId: req.user?._id,
      operation: "create",
      entityType: "User",
      entityId: newUser._id,
      details: newUser.toObject(),
    });
    res.status(201).json({
      success: true,
      message: "ƒ∞stifad…ô√ßi uƒüurla yaradƒ±ldƒ±!",
      user: newUser,
    });
  } catch (err) {
    console.error("Error creating user:", err);
    res
      .status(500)
      .json({ message: "ƒ∞stifad…ô√ßi yaradƒ±lmasƒ± zamanƒ± server x…ôtasƒ±" });
  }
};

exports.getUser = async (req, res) => {
  const { userId } = req.params;

  try {
    const requestingUser = req.user; // Token-d…ôn g…ôl…ôn istifad…ô√ßi m…ôlumatƒ±
    // console.log(requestingUser);

    // ∆èg…ôr √∂z m…ôlumatƒ±nƒ± √ß…ôkirs…ô, icaz…ô yoxlamasƒ±na ehtiyac yoxdur:
    const isSelf = requestingUser.userId === userId;
    if (!isSelf) {
      const requesterRoleData = await Role.findById(requestingUser.roleId);
      if (!requesterRoleData) {
        return res.status(403).json({ message: "Sizin rol tapƒ±lmadƒ±" });
      }
      const isAdmin = requesterRoleData.name === "admin";

      if (!isAdmin) {
        const permissions = requesterRoleData.permissions;

        const hasReadPermission = permissions.roles?.some(
          (rp) => rp.permissions.read
        );
        if (!hasReadPermission) {
          return res.status(403).json({
            message: "ƒ∞stifad…ô√ßi m…ôlumatƒ±nƒ± g√∂rm…ôk icaz…ôniz yoxdur",
          });
        }
      }
    }

    const user = await User.findById(userId).populate("role", "name");
    if (!user) {
      return res.status(404).json({ message: "ƒ∞stifad…ô√ßi tapƒ±lmadƒ±" });
    }

    res.status(200).json({
      success: true,
      user: {
        identityNumber: user.identityNumber,
        fname: user.fname,
        lname: user.lname,
        fathername: user.fathername,
        email: user.email,
        bDate: user.bDate,
        phoneNumber: user.phoneNumber,
        status: user.status,
        role: user.role?._id || null,
        roleName: user.role?.name || null,
        dynamicFields: user.dynamicFields,
        balance: user.balance,
        address: user.address,
        _id: user._id,
      },
    });
  } catch (err) {
    console.error(err);
    res.status(500).json({
      message: "ƒ∞stifad…ô√ßinin g√∂t√ºr√ºlm…ôsi zamanƒ± server x…ôtasƒ±",
    });
  }
};

exports.getAllUsers = async (req, res) => {
  try {
    const requesterRole = await Role.findById(req.user.roleId);

    if (!requesterRole) {
      return res.status(403).json({ message: "ƒ∞stifad…ô√ßinin rolu tapƒ±lmadƒ±" });
    }

    let users = [];

    if (requesterRole.name === "admin") {
      users = await User.find({ _id: { $ne: req.user.userId } }).populate(
        "role"
      );
    } else {
      const permissionsRoles = requesterRole.permissions.roles || [];
      const readableRoleIds = permissionsRoles
        .filter((p) => p.permissions?.read)
        .map((p) => p.role.toString());

      if (readableRoleIds.length === 0) {
        return res.status(200).json({ success: true, users: [] });
      }

      users = await User.find({
        role: { $in: readableRoleIds },
      }).populate("role");
    }

    // üîÅ H…ôr bir user √º√ß√ºn m√ºqavil…ôl…ôri tap
    const enrichedUsers = await Promise.all(
      users.map(async (user) => {
        const userContracts = await Contract.find({
          subscriberId: user._id,
        }).select("contractNumber"); // Sad…ôc…ô contractNumber √ß…ôkirik

        const contractNames = userContracts.map((c) => c.contractNumber);

        return {
          identityNumber: user.identityNumber,
          fname: user.fname,
          lname: user.lname,
          fathername: user.fathername,
          phoneNumber: user.phoneNumber,
          email: user.email,
          bDate: user.bDate,
          role: user.role?.name,
          status: user.status,
          _id: user._id,
          address: user.address,
          contracts: contractNames, // üÜï ∆èlav…ô etdik
        };
      })
    );

    return res.status(200).json({
      success: true,
      users: enrichedUsers,
    });
  } catch (err) {
    console.error(err);
    res
      .status(500)
      .json({ message: "ƒ∞stifad…ô√ßil…ôrin g√∂t√ºr√ºlm…ôsi zamanƒ± server x…ôtasƒ±" });
  }
};

exports.getUsersByRole = async (req, res) => {
  const { roleName } = req.params;

  try {
    const role = await Role.findOne({ name: roleName });

    if (!role) {
      return res.status(400).json({ message: "Rol tapƒ±lmadƒ±!" });
    }

    // Bu role sahib istifad…ô√ßil…ôri tapƒ±rƒ±q v…ô onlarƒ±n rolunu `populate` il…ô daxil edirik
    const users = await User.find({ role: role._id }).populate("role");

    res.status(200).json({
      success: true,
      users: users.map((user) => ({
        fname: user.fname,
        lname: user.lname,
        fathername: user.fathername,
        email: user.email,
        bDate: user.bDate,
        phoneNumber: user.phoneNumber,
        _id: user.id,
        role: role._id, // `role.name` olaraq rolun adƒ±nƒ± alƒ±rƒ±q
        status: user.status,
        address: user.address,
      })),
    });
  } catch (err) {
    console.error(err);
    res
      .status(500)
      .json({ message: "ƒ∞stifad…ô√ßil…ôri rola g√∂r…ô g…ôtir…ôrk…ôn server x…ôtasƒ±" });
  }
};
// Redakt…ô etm…ôk (edit) √º√ß√ºn metod
exports.editUser = async (req, res) => {
  const { userId } = req.params;
  const {
    fname,
    lname,
    fathername,
    email,
    bDate,
    status,
    dynamicFields,
    phoneNumber,
    identityNumber,
    role,
    address,
  } = req.body;

  try {
    const requestingUser = req.user;
    const user = await User.findById(userId);
    const oldData = user.toObject();
    if (!user) {
      return res.status(404).json({ message: "ƒ∞stifad…ô√ßi tapƒ±lmadƒ±" });
    }

    const isSelf = requestingUser.id === userId;
    if (!isSelf) {
      const requesterRoleData = await Role.findById(requestingUser.roleId);
      if (!requesterRoleData) {
        return res.status(403).json({ message: "Sizin rol tapƒ±lmadƒ±" });
      }

      const isAdmin = requesterRoleData.name === "admin";

      if (!isAdmin) {
        const permissions = requesterRoleData.permissions;

        // user-in hazƒ±rkƒ± roluna g√∂r…ô edit icaz…ôsini yoxla:
        const userRoleId = String(user.role);
        const rolePermission = permissions.roles?.find(
          (rp) => rp.role === userRoleId
        );

        if (!rolePermission || !rolePermission.permissions.edit) {
          return res.status(403).json({
            message: "Bu istifad…ô√ßini redakt…ô etm…ôk icaz…ôniz yoxdur",
          });
        }
      }
    }

    // ƒ∞stifad…ô√ßi m…ôlumatlarƒ±nƒ± yenil…ôyirik
    user.fname = fname || user.fname;
    user.lname = lname || user.lname;
    user.fathername = fathername || user.fathername;
    user.email = email || user.email;
    user.bDate = bDate || user.bDate;
    user.phoneNumber = phoneNumber || user.phoneNumber;
    user.role = role || user.role;
    user.status = typeof status === "boolean" ? status : user.status;
    user.dynamicFields = dynamicFields || user.dynamicFields;
    user.identityNumber = identityNumber || user.identityNumber;
    user.address = address || user.address;

    await user.save();
    const { before, after } = getChangedFields(oldData, user.toObject());

    await createLog({
      userId: req.user?._id,
      operation: "update",
      entityType: "User",
      entityId: user._id,
      details: { before, after },
    });
    res.status(200).json({
      success: true,
      message: "ƒ∞stifad…ô√ßi uƒüurla yenil…ôndi!",
      user,
    });
  } catch (err) {
    console.error("Error updating user:", err);
    res
      .status(500)
      .json({ message: "ƒ∞stifad…ô√ßi yenil…ôm…ôsi zamanƒ± server x…ôtasƒ±" });
  }
};

// Silm…ôk (delete) √º√ß√ºn metod
exports.deleteUser = async (req, res) => {
  const { userId } = req.params;

  try {
    const targetUser = await User.findById(userId); // silin…ôc…ôk user

    if (!targetUser) {
      return res.status(404).json({ message: "ƒ∞stifad…ô√ßi tapƒ±lmadƒ±" });
    }

    const currentUser = req.user; // token-d…ôn g…ôl…ôn user

    // ∆èg…ôr admin deyils…ô v…ô delete icaz…ôsi yoxdursa, qadaƒüan et

    await User.findByIdAndDelete(userId);
    await createLog({
      userId: req.user?._id,
      operation: "delete",
      entityType: "User",
      entityId: targetUser._id,
      details: targetUser.toObject(),
    });
    res.status(200).json({
      success: true,
      message: "ƒ∞stifad…ô√ßi uƒüurla silindi!",
    });
  } catch (err) {
    console.error("Error deleting user:", err);
    res
      .status(500)
      .json({ message: "ƒ∞stifad…ô√ßinin silinm…ôsi zamanƒ± server x…ôtasƒ±" });
  }
};
// Yeni metod
const Contract = require("../models/Contract");

exports.getUserNameById = async (req, res) => {
  const { userId } = req.params;

  try {
    const user = await User.findById(userId)
      .select("fname lname role")
      .populate("role", "name");

    if (!user) {
      return res.status(404).json({ message: "ƒ∞stifad…ô√ßi tapƒ±lmadƒ±" });
    }

    // üîê 1. ∆èg…ôr admin-dirs…ô, davam et
    const isAdmin = req.user.role === "admin";

    // üîê 2. Admin deyils…ô, icaz…ô yoxla
    let hasPermission = false;
    if (!isAdmin) {
      const requesterRole = await Role.findById(req.user.roleId);
      if (!requesterRole) {
        return res.status(403).json({ message: "Rolu tapmaq m√ºmk√ºn olmadƒ±" });
      }
      hasPermission = requesterRole.permissions?.read === true;
      if (!hasPermission) {
        return res.status(403).json({ message: "ƒ∞caz…ôniz yoxdur" });
      }
    }

    // üìÑ 3. M√ºqavil…ôl…ôri tap (contract.subscriberId = user._id)
    const contracts = await Contract.find({ subscriberId: userId }).select(
      "servicePackage"
    );

    // üì¶ 4. Xidm…ôt paketl…ôrini tap (unikal ID-l…ôrd…ôn)
    const packageIds = contracts.map((c) => c.servicePackage).filter(Boolean);
    const servicePackages = await ServicePackage.find({
      _id: { $in: packageIds },
    }).select("name totalPrice validity status");

    // ‚úÖ 5. M…ôlumatƒ± qaytar
    return res.status(200).json({
      success: true,
      user: {
        fname: user.fname,
        lname: user.lname,
        packages: servicePackages,
      },
    });
  } catch (err) {
    console.error(err);
    res.status(500).json({ message: "Server x…ôtasƒ±" });
  }
};
exports.getTechnicianUsers = async (req, res) => {
  try {
    // 1. "usta" rolunu tapƒ±rƒ±q
    const role = await Role.findOne({ name: "usta" });

    // ∆èg…ôr rol tapƒ±lmazsa, bo≈ü array qaytar
    if (!role) {
      return res.status(200).json({
        success: true,
        users: [],
      });
    }

    // 2. Bu rola sahib istifad…ô√ßil…ôri tapƒ±rƒ±q
    const users = await User.find({ role: role._id }).select(
      "fname lname email status"
    );

    res.status(200).json({
      success: true,
      users,
    });
  } catch (err) {
    console.error("Ustalar tapƒ±lark…ôn x…ôta:", err);
    res.status(500).json({ message: "Server x…ôtasƒ±" });
  }
};
